# HN Rerank

> A personalized, privacy-first Hacker News dashboard that learns from your upvotes.

HN Rerank fetches stories from the last 30 days and re-ranks them based on semantic similarity to your Hacker News history (upvoted/favorited stories). It runs entirely locally using ONNX models—no data ever leaves your machine.

Requires Python 3.12+ (uses stdlib `tomllib` for config loading).

## Features

- **Multi-Interest Clustering**: Automatically discovers your interest clusters from upvote history using Agglomerative Clustering. Cluster names are generated by Groq API (Llama 3).
- **Per-Story Cluster Tags**: Each recommended story shows which of your interest clusters it matches.
- **Cluster Stability**: Clusters are guaranteed to have at least three signals before splitting to keep interest groups coherent.
- **Story TL;DRs**: LLM-generated summaries (up to 800 chars) covering the story and key discussion points, replacing the raw comments view.
- **Personalized Ranking**: Uses local BGE-base embeddings to find stories matching your specific interests.
- **MMR Diversity**: Maximal Marginal Relevance prevents showing 30 stories on the same topic.
- **RSS Expansion**: Pulls additional candidates from a curated OPML list of high-signal feeds.
- **Privacy-First**: Your credentials and history stay in `.cache/`. Embeddings run locally.
- **Smart Summaries**: Weighted breadth-first comment selection to capture diverse viewpoints.

**Notes**
- RSS items fetch full article text (via `trafilatura`) for embeddings and cache results in `.cache/rss`.
- RSS ranking uses semantic score only (no HN score or freshness boost), and the final list targets a 2:1 HN:RSS mix (best-effort based on availability).
- Cluster names are required to come from the Groq call; missing or empty Groq responses raise an error.

## Quick Start

1. **Install Dependencies**:
   ```bash
   uv sync
   ```

2. **Setup Model**:
   ```bash
   uv run setup_model.py
   ```

3. **Configure API Key**:
   ```bash
   export GROQ_API_KEY="your-api-key"
   ```
   For persistent `systemd --user` timer runs, store it in a user-only file:
   ```bash
   mkdir -p ~/.config/hn_rerank
   umask 077
   cat > ~/.config/hn_rerank/secrets.env <<'EOF'
   GROQ_API_KEY=your-api-key
   EOF
   chmod 600 ~/.config/hn_rerank/secrets.env
   ```

4. **Generate Dashboard**:
   ```bash
   uv run generate_html.py <your-hn-username> --days 7 --clusters 30
   ```
   (Add `--no-rss` to disable RSS candidates.)
   Outputs:
   - `index.html` - Ranked story recommendations with cluster tags and TL;DRs
   - `clusters.html` - Detailed interest cluster visualization
   
   ## How It Works
   
   1. **Profile Building**: Fetches your upvoted stories from HN (requires login)
   2. **Clustering**: Groups your upvotes into interest clusters (e.g., "ML/AI", "Rust", "Startups")
   3. **Candidate Fetching**: Gets recent popular stories from Algolia (default: last 30 days, auto-update uses 7 days)
   4. **Ranking**: Scores candidates by similarity to your interest clusters
   5. **Diversity**: Applies MMR to ensure variety in recommendations
   
## Configuration
   
Key parameters in `api/constants.py`:
   - `MAX_USER_STORIES`: Number of upvotes to analyze (default: 1000)
   - `CANDIDATE_FETCH_COUNT`: Stories to consider (default: 200)
   - `ALGOLIA_DEFAULT_DAYS`: Time window for candidates (default: 30)
   - `MIN_CLUSTERS` / `MAX_CLUSTERS`: Clustering bounds (2-40)
- `RSS_OPML_URL`: Curated OPML list of RSS feeds
- `RSS_MAX_FEEDS` / `RSS_PER_FEED_LIMIT`: RSS candidate limits

You can also create a `hn_rerank.toml` in the repo root to avoid long CLI flags:

```toml
# hn_rerank.toml
username = "your-hn-username"
days = 7
clusters = 30
count = 30
no_rss = false
no_tldr = true
debug_scores = false
```

When `debug_scores = true` (or `--debug-scores`), a `scores_debug.json` file is written next to `index.html` with a per‑story score breakdown.

## Systemd Timer

If you run with `hn_rerank.timer`, reload units after changes:

```bash
cp /home/dev/hn_rerank/hn_rerank.service ~/.config/systemd/user/hn_rerank.service
cp /home/dev/hn_rerank/hn_rerank.timer ~/.config/systemd/user/hn_rerank.timer
systemctl --user daemon-reload
systemctl --user enable --now hn_rerank.timer
```

Run one manual check:

```bash
systemctl --user start hn_rerank.service
journalctl --user -u hn_rerank.service -n 50 --no-pager
```
## Documentation

- [**ARCHITECTURE.md**](ARCHITECTURE.md): Deep dive into the scoring algorithms, clustering, and data flow.
- [**TECHNICAL_DEBT.md**](TECHNICAL_DEBT.md): Security audit, performance notes, and future roadmap.

## Development

```bash
# Run tests
uv run pytest

# Run with coverage
uv run pytest --cov=api

# Lint
uv run ruff check .

# Type check
uv run ty check .
```

### Stable Multi-Seed Parameter Promotion

Use the promotion runner to automate tuning across multiple seeds and only emit
new params when gains are stable against baseline:

```bash
uv run promote_stable_params.py <your-hn-username> \
  --seeds 42,43,44 \
  --space core \
  --trials 120 \
  --cv-folds 5 \
  --candidates 500 \
  --cache-only
```

Artifacts are written under `runs/promotion/<timestamp>_*`:
- `promotion_report.json`: per-seed run outputs + baseline/candidate comparisons
- `promoted_params.json` and `promoted_params.toml`: only written when stability
  gates pass (`mean_delta`, 95% lower confidence bound, regression-count limit)

## UI Invariants and Change Demos

Use Rodney for browser-level invariant checks on generated dashboard artifacts:

```bash
# Regenerate artifacts first (scheduled profile disables TL;DRs)
uv run generate_html.py <your-hn-username> --no-tldr

# Verify rendered invariants
./scripts/check_ui_invariants.sh

# Optional: also capture fresh screenshots
./scripts/check_ui_invariants.sh --screenshots
```

Use Showboat for reproducible change documentation and regression checks:

```bash
# Verify existing demo docs still reproduce
./scripts/verify_showboat_demos.sh

# Create a new change demo
uvx showboat init demo_new_change.md "Demo: <change title>"
uvx showboat note demo_new_change.md "What changed and why"
uvx showboat exec demo_new_change.md bash "./scripts/check_ui_invariants.sh"
uvx showboat verify demo_new_change.md
```

If `showboat verify` fails, refresh the demo by re-running the recorded commands
or regenerate updated output with `showboat verify <file> --output <new-file>`.

Recommended workflow for UI-affecting changes:
1. Regenerate `index.html` and `clusters.html`.
2. Run `./scripts/check_ui_invariants.sh`.
3. Update or add a Showboat demo and verify it.
